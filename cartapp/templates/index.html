{% extends 'base.html' %}

{% block title%} Home{% endblock %}
<!--        carousel indicators starts from here-->
{%load static%}

{% block body%}

<div class="container py-4">
  <table class="table text-primary" id="datatable">
    <thead>
      <tr class="bg-warning">
        <th>Name</th>
        <th>Price</th>
        <th>Description</th>
        <th>Add to Cart</th>
      </tr>
    </thead>
    <tbody>
      {% for product in products %}
      <tr>
        <td>{{ product.product_name }}</td>
        <td>{{ product.price }}</td>
        <td>{{ product.desc | slice:"0:53" }}...</td>
        <td>
          <button id="pr{{ product.id }}" class="btn btn-primary cart">Add To Cart</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class='container py-3 mx-5 text-center'>
    {% comment %} <button class='btn btn-primary btn-lg' onclick='clearCart()' id='clearCart'>Clear Cart</button> {% endcomment %}
    
  </div>
</div>

{% endblock %}

{% block js %}
<script src="https://code.jquery.com/jquery-3.5.1.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.4/js/dataTables.bootstrap4.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
  function updatePopover(cart) {
    var popStr = "";
    popStr += "<h5>Cart for your items in my shopping cart</h5><div class='mx-2 my-2'>";
    var i = 1;
    for (var item in cart) {
      popStr += "<b>" + i + "</b>. ";
      popStr += cart[item][1].slice(0, 19) + "... Qty: " + cart[item][0] + "<br>";
      i++;
    }
    popStr += "</div><div class='text-center'><a href='{% url 'checkout' %}' class='btn btn-primary'>Checkout</a></div>";
    document.getElementById("popcart").setAttribute("data-content", popStr);
    $("#popcart").popover("show");
  }
  
  function clearCart() {
    var cart = JSON.parse(localStorage.getItem("cart"));
    for (var item in cart) {
      var elementId = item;
      var element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = '<button id="' + elementId + '" class="btn btn-primary cart">Add To Cart</button>';
      }
    }
    localStorage.clear();
    cart = {};
    updateCart(cart);
  }
  function updateCart(cart) {
    var sum = 0;
    for (var item in cart) {
      sum += cart[item][0];
      var itemId = item.substring(2);
      $(`#pr${itemId}`)
        .closest("tr")
        .find("td:nth-child(4)")
        .html(
          "<button id='minus" +
            itemId +
            "' class='btn btn-primary minus'>-</button> <span id='val" +
            itemId +
            "'>" +
            cart[item][0] +
            "</span> <button id='plus" +
            itemId +
            "' class='btn btn-primary plus'> + </button>"
        );
    }
    localStorage.setItem("cart", JSON.stringify(cart));
    $("#cart").html(sum);
    updatePopover(cart);
  
    // Add event listeners for plus and minus buttons
    $(document)
      .off("click", ".minus")
      .on("click", ".minus", function() {
        var itemId = this.id.substring(5); // Extract the item ID from the button ID
        cart["pr" + itemId][0] = Math.max(0, cart["pr" + itemId][0] - 1);
        $("#val" + itemId).html(cart["pr" + itemId][0]);
        updateCart(cart);
      });
  
    $(document)
      .off("click", ".plus")
      .on("click", ".plus", function() {
        var itemId = this.id.substring(4); // Extract the item ID from the button ID
        cart["pr" + itemId][0] = cart["pr" + itemId][0] + 1;
        $("#val" + itemId).html(cart["pr" + itemId][0]);
        updateCart(cart);
      });
  }
  
  $(document).ready(function() {
    $("#datatable").DataTable({
      "initComplete": function() {
        var cart = JSON.parse(localStorage.getItem("cart"));
        if (!cart) {
          cart = {};
        } else {
          updateCart(cart);
        }
        
        $(document).on("click", ".cart", function() {
          var idstr = this.id.toString();
          if (cart[idstr] != undefined) {
            qty = cart[idstr][0] + 1;
          } else {
            qty = 1;
            name = $(this).closest("tr").find("td:nth-child(1)").text();
            price = $(this).closest("tr").find("td:nth-child(2)").text();
            cart[idstr] = [qty, name, parseInt(price)];
          }
          updateCart(cart);
          $(this).html('Added');
        });

        $("#popcart").popover();
        updatePopover(cart);
      }
    });
  });
</script>
{% endblock %}

